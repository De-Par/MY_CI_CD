name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CLANG_FORMAT_VERSION: "21"

jobs:
  clang-format:
    name: "Lint: clang-format"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${CLANG_FORMAT_VERSION}
          sudo apt-get install -y clang-format-${CLANG_FORMAT_VERSION}

      - name: Run clang-format (check only)
        run: |
          files=$(find src include app tests -name '*.cpp' -o -name '*.hpp')
          if [ -n "$files" ]; then
            clang-format-${CLANG_FORMAT_VERSION} --dry-run --Werror $files
          fi

  clang-tidy:
    name: "Analyze: clang-tidy"
    runs-on: ubuntu-latest
    needs: clang-format

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang + clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang clang-tidy

      - name: Setup Meson env
        uses: ./.github/actions/setup-meson-env

      - name: Configure (Meson, debug, clang)
        env:
          CC: clang
          CXX: clang++
        run: |
          meson setup build-tidy \
            --buildtype=debug \
            --backend=ninja

      - name: Build (for compile_commands.json)
        run: meson compile -C build-tidy

      - name: Run clang-tidy
        run: |
          files=$(find src include app tests -name '*.cpp')
          if [ -n "$files" ]; then
            for f in $files; do
              echo "==> clang-tidy $f"
              clang-tidy "$f" -p build-tidy --warnings-as-errors='*'
            done
          fi

  build-debug:
    name: "Build/Test: debug"
    needs: clang-tidy
    uses: ./.github/workflows/build-test-reusable.yml
    with:
      buildtype: debug
      run-tests: true

  build-release:
    name: "Build/Test: release"
    needs: clang-tidy
    uses: ./.github/workflows/build-test-reusable.yml
    with:
      buildtype: release
      run-tests: true