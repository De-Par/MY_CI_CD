name: sanitizers

on:
  workflow_call:
    inputs:
      test_timeout_multiplier:
        description: "Multiplier for meson test timeout"
        required: false
        default: "1"
        type: string
      run_tsan:
        description: "Enable TSan run"
        required: false
        default: "false"
        type: string

jobs:
  sanitizers:
    # ASan/UBSan всегда; TSan по флагу
    name: sanitizers (${{ matrix.sanitizer }})
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CI_TEST_TIMEOUT_MULTIPLIER: ${{ inputs.test_timeout_multiplier }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - sanitizer: address
          - sanitizer: undefined
          - sanitizer: thread
    if: ${{ matrix.sanitizer != 'thread' || inputs.run_tsan == 'true' }}
    continue-on-error: ${{ matrix.sanitizer == 'thread' }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup_meson_env
      - name: Configure (sanitizer)
        run: meson setup build-${{ matrix.sanitizer }} --buildtype=debug -Db_sanitize=${{ matrix.sanitizer }} -Db_lundef=false
      - name: Build (sanitizer)
        run: meson compile -C build-${{ matrix.sanitizer }}
      - name: Test (sanitizer)
        run: meson test -C build-${{ matrix.sanitizer }} --print-errorlogs --timeout-multiplier="${CI_TEST_TIMEOUT_MULTIPLIER}"
      - name: Upload sanitizer logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.sanitizer }}
          path: build-${{ matrix.sanitizer }}/meson-logs
